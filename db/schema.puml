@startuml
title StickyBoard â€“ Data Layer UML Overview

' General appearance
skinparam classAttributeIconSize 0
hide circle
hide methods
skinparam packageStyle rectangle
skinparam class {
    BackgroundColor White
    ArrowColor #444
    BorderColor #333
}

' ==========================================================
' USERS & AUTH
' ==========================================================
package "Users" {
    class User {
        +Id : uuid
        +Email : text
        +DisplayName : text
        +AvatarUri : text
        +Prefs : jsonb
        +CreatedAt : timestamptz
        +UpdatedAt : timestamptz
    }

    class AuthUser {
        +UserId : uuid
        +PasswordHash : text
        +Role : user_role
        +LastLogin : timestamptz
    }

    class RefreshToken {
        +TokenHash : text
        +UserId : uuid
        +ExpiresAt : timestamptz
        +Revoked : bool
    }

    class UserRelation {
        +UserId : uuid
        +FriendId : uuid
        +Status : relation_status
    }
}

User "1" --> "1" AuthUser : auth
User "1" --> "many" RefreshToken : tokens
User "many" --> "many" UserRelation : friends

' ==========================================================
' ORGANIZATIONS
' ==========================================================
package "Organizations" {
    class Organization {
        +Id : uuid
        +Name : text
        +OwnerId : uuid
    }

    class OrganizationMember {
        +OrgId : uuid
        +UserId : uuid
        +Role : org_role
    }
}

User "1" --> "many" Organization : owns
Organization "1" --> "many" OrganizationMember : members
OrganizationMember --> User

' ==========================================================
' BOARDS & PERMISSIONS
' ==========================================================
package "Boards" {
    class Board {
        +Id : uuid
        +OwnerId : uuid
        +OrgId : uuid
        +ParentBoardId : uuid
        +Title : text
        +Visibility : board_visibility
        +Theme : jsonb
        +Rules : jsonb
    }

    class Permission {
        +UserId : uuid
        +BoardId : uuid
        +Role : board_role
        +GrantedAt : timestamptz
    }
}

Organization --> Board
User --> Board : owns
Board "1" --> "many" Permission
Permission --> User

' ==========================================================
' SECTIONS & TABS
' ==========================================================
package "Sections & Tabs" {
    class Section {
        +Id : uuid
        +BoardId : uuid
        +Title : text
        +Position : int
        +LayoutMeta : jsonb
    }

    class Tab {
        +Id : uuid
        +Scope : tab_scope
        +BoardId : uuid
        +SectionId : uuid
        +Title : text
        +LayoutConfig : jsonb
        +Position : int
    }
}

Board --> Section
Section --> Tab

' ==========================================================
' CARDS & TAGS
' ==========================================================
package "Cards & Tags" {
    class Card {
        +Id : uuid
        +BoardId : uuid
        +SectionId : uuid
        +TabId : uuid
        +Type : card_type
        +Status : card_status
        +Title : text
        +Content : jsonb
    }

    class Tag {
        +Id : uuid
        +Name : text
    }

    class CardTag {
        +CardId : uuid
        +TagId : uuid
    }

    class Link {
        +Id : uuid
        +FromCard : uuid
        +ToCard : uuid
        +RelType : link_type
    }
}

Section --> Card
Card "many" --> "many" Tag : via CardTag
Card "1" --> "many" Link : relationships

' ==========================================================
' CLUSTERING & RULES
' ==========================================================
package "Clustering & Rules" {
    class Cluster {
        +Id : uuid
        +BoardId : uuid
        +ClusterType : cluster_type
        +RuleDef : jsonb
        +VisualMeta : jsonb
    }

    class Rule {
        +Id : uuid
        +BoardId : uuid
        +Definition : jsonb
        +Enabled : bool
    }
}

Board --> Cluster
Board --> Rule

' ==========================================================
' ACTIVITIES
' ==========================================================
package "Activities" {
    class Activity {
        +Id : uuid
        +BoardId : uuid
        +CardId : uuid
        +ActorId : uuid
        +ActType : activity_type
        +Payload : jsonb
    }
}

Board --> Activity
Card --> Activity

' ==========================================================
' FILES & OPERATIONS
' ==========================================================
package "Files & Operations" {
    class File {
        +Id : uuid
        +OwnerId : uuid
        +BoardId : uuid
        +CardId : uuid
        +StorageKey : text
        +Meta : jsonb
    }

    class Operation {
        +Id : uuid
        +DeviceId : text
        +UserId : uuid
        +Entity : entity_type
        +EntityId : uuid
        +OpType : text
        +Payload : jsonb
    }
}

User --> File
Board --> File
Card --> File

' ==========================================================
' WORKER QUEUE
' ==========================================================
package "Worker" {
    class WorkerJob {
        +Id : uuid
        +JobKind : job_kind
        +Status : job_status
        +Payload : jsonb
        +Priority : int
        +RunAt : timestamptz
    }

    class WorkerJobAttempt {
        +Id : bigint
        +JobId : uuid
        +StartedAt : timestamptz
        +Ok : bool
        +Error : text
    }

    class WorkerJobDeadletter {
        +Id : uuid
        +JobId : uuid
        +JobKind : job_kind
        +LastError : text
    }
}

WorkerJob "1" --> "many" WorkerJobAttempt
WorkerJob --> WorkerJobDeadletter

' ==========================================================
' MESSAGING & INVITES
' ==========================================================
package "Messaging" {
    class Message {
        +Id : uuid
        +SenderId : uuid
        +ReceiverId : uuid
        +Subject : text
        +Body : text
        +Type : message_type
        +Status : message_status
    }

    class Invite {
        +Id : uuid
        +SenderId : uuid
        +Email : text
        +BoardId : uuid
        +OrgId : uuid
        +Token : text
        +Accepted : bool
        +ExpiresAt : timestamptz
    }
}

User --> Message : sends
User --> Invite : issues
Board --> Invite
Organization --> Invite

@enduml
